---
title: "Zarr features supported by different implementations"
---

```{r}
#| echo: false
read_tap <- function(path) {
  lines <- readLines(path)

  # Number of tests. FIXME: take this into account in the future.
  lines <- lines[-1]

  tests <- lines[!startsWith(lines, "#")]

  status <- gsub("((not )?ok) .*", "\\1", tests)
  test_number <- as.integer(gsub("((not )?ok) ([0-9]+).*", "\\3", tests))
  test_name <- gsub("((not )?ok) ([0-9]+) (.*)", "\\4", tests)

  setNames(
    factor(status, levels = c("ok", "not ok")),
    test_name
  )
}
```

```{r}
#| echo: false
taps <- fs::dir_ls("outputs") |> 
  rlang::set_names(~ basename(.x)) |> 
  purrr::imap(function(implementation_path, implementation_name) {
    tap <- read_tap(file.path(implementation_path, "conformance-test-results.tap"))
    metadata <- jsonlite::read_json(file.path(implementation_path, "last-run-metadata.json"), simplify = TRUE)
    data.frame(implementation = implementation_name, metadata, as.list(tap), check.names = FALSE)
  })
merged_tap <- dplyr::bind_rows(taps)
```

```{r}
#| echo: false
merged_tap |> 
  dplyr::mutate(
    `last run` = glue::glue("[{format(as.POSIXct(createdAt))}]({url})"),
    .after = 1,
    .keep = "unused"
  ) |> 
  gt::gt() |> 
  gt::tab_header(
    title = "Test Results Across Implementations"
  ) |> 
  gt::fmt_markdown(
    columns = dplyr::everything()
  ) |> 
  gt::data_color(
    columns = -dplyr::any_of(c("implementation", "last run")),
    palette = c(
      "ok" = "lightgreen",
      "not ok" = "salmon"
    )  
  )
```