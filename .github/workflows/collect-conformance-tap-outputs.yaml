name: collect-conformance-tap-outputs

on:
  workflow_dispatch:
  schedule:
    - cron: '17 3 * * 1'

permissions:
  contents: write
  actions: write

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Collect latest 'conformance-test-results' artifact from each implementation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # For each implementation, get the latest artifact named 'conformance-test-results' and download it
          # Use the `name` field from implementations.json for the output directory
          jq -c '.[]' implementations.json | while IFS= read -r item; do
            repo=$(jq -r '.cli_repo' <<< "$item")
            name=$(jq -r '.name' <<< "$item")
            workflow=$(jq -r '.conformance_workflow' <<< "$item")
            echo "Processing $repo (name: $name)"
            mkdir -p "outputs/$name"
            cd "outputs/$name"
            # Overwrite existing results
            find . -name conformance-test-results.tap -type f -delete
            # Save test output (TAP file)
            gh run download -n conformance-test-results -R "$repo"
            # Save last run metadata (link and date)
            gh run list -R "$repo" -w "$workflow" --limit 1 --json createdAt,url >| last-run-metadata.json
            cd ../..
          done
      
      - name: Commit collected TAP files & metadata
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add outputs/*
          git commit -m "Collect conformance test TAP outputs" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Re-render website
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run build-deploy-quarto.yaml
